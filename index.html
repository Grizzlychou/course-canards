<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Course des Canards</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
  body {
    margin: 0;
    font-family: 'Roboto', sans-serif;
    background: #fff8d6;
    color: #333;
  }
  header {
    background: #ffe600;
    text-align: center;
    padding: 20px;
    color: #000;
    font-family: 'Fredoka One', cursive;
  }
  header h1 {
    font-size: 2.5em;
    margin: 0;
  }
  header p {
    margin: 5px 0 0;
    font-size: 1.5em;
  }
  .hero {
    background: linear-gradient(#a6e1fa, #7cd1c0);
    text-align: center;
    padding: 40px 20px;
  }
  .hero img {
    max-width: 300px;
  }
  .hero h2 {
    font-family: 'Fredoka One', cursive;
    font-size: 2.5em;
    margin: 20px 0 10px;
    color: #000;
  }
  .hero p {
    font-size: 1.2em;
    color: #000;
  }
  .reserve-button {
    display: inline-block;
    background: #ffe600;
    color: #000;
    font-size: 1.2em;
    padding: 15px 30px;
    text-decoration: none;
    border-radius: 50px;
    margin-top: 20px;
    font-weight: bold;
  }
  .reserve-button:hover {
    background: #ffd700;
  }
  .info {
    max-width: 800px;
    margin: 40px auto;
    text-align: center;
    background: white;
    padding: 20px;
    border-radius: 8px;
  }
  .info h3 {
    font-family: 'Fredoka One', cursive;
    font-size: 2em;
  }
  footer {
    text-align: center;
    font-size: 0.9em;
    color: #666;
    margin: 40px 0 20px;
  }

  /* Styles de la modale et de la grille */
  #duckModal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow-y:auto; background:rgba(0,0,0,0.8); }
  #duckModal .modal-content { background:#fff8d6; margin:5% auto; padding:20px; border-radius:8px; max-width:900px; position:relative; }
  #duckModal .close { position:absolute; top:10px; right:20px; font-size:1.8em; cursor:pointer; }

  .duck-grid { position:relative; width:100%; height:auto; }
  .duck-grid img { width:100%; display:block; }
  .duck { position:absolute; cursor:pointer; }
  .duck.reserved { background:rgba(255,0,0,0.4); pointer-events:none; }
  .duck.selected { background:rgba(255,255,0,0.4); }

  #selection { margin-top:15px; font-size:1.1em; }
  #selection span { font-weight:bold; }

  /* Fen√™tre de confirmation */
  #confirmModal { display:none; position:fixed; z-index:1100; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8); }
  #confirmModal .content { background:#fff8d6; margin:10% auto; padding:20px; max-width:600px; border-radius:8px; position:relative; }
  #confirmModal .close { position:absolute; top:10px; right:20px; font-size:1.8em; cursor:pointer; }
</style>
</head>
<body>

<header>
  <h1>Le Grizzlies Dodgeball Club de Jodoigne</h1>
  <div style="margin: 15px 0;">
    <img src="img/logo-grizzlies.png" alt="Logo Grizzlies" style="height: 100px;">
  </div>
  <p>organise</p>
</header>

<div class="hero">
  <img src="img/affiche-courses.jpg" alt="Course des Canards" style="width: 100%; display: block; margin: 0;">
  <h2>La course la plus fun de l'ann√©e‚ÄØ!</h2>
  <p>2‚ÄØ‚Ç¨/mise ‚Äî nombreux prix pour le podium ‚Äî Entr√©e libre‚ÄØ!</p>
  <a href="#reserve" class="reserve-button" id="reserve-button">üê• R√©server mon canard</a>
</div>

<div class="info">
  <h3>Comment participer‚ÄØ?</h3>
  <p>Rendez-vous √† la Stampia, Jodoigne le 24/08 √† 15h.<br>
     Vous pouvez d√©j√† r√©server votre canard en ligne et choisir vos num√©ros le jour J‚ÄØ!</p>
</div>

<footer>
  &copy; 2025 Grizzlies Dodgeball Club ‚Äî Site propuls√© par GitHub Pages
</footer>

<!-- Modale principale (s√©lection + formulaire) -->
<div id="duckModal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <h3>Choisissez vos canards (2‚ÄØ‚Ç¨ chacun)</h3>
    <div class="duck-grid" id="duckGrid">
      <img src="img/320-canards-jaunes.png" alt="320 canards">
    </div>
    <div id="selection">
      Canards s√©lectionn√©s¬†: <span id="selectedNumbers">aucun</span><br>
      Total¬†: <span id="totalCost">0¬†‚Ç¨</span>
    </div>
    <!-- Formulaire de paiement -->
    <div id="paiement">
      <!-- ‚Ä¶radios, email, cases √† cocher‚Ä¶ -->
    </div>
    <button id="finaliser" style="margin-top:15px;padding:10px 20px;font-size:1.2em;">Finaliser ma commande</button>
  </div>
</div>

<!-- Modale de confirmation -->
<div id="confirmModal">
  <div class="content">
    <span class="close" id="closeConfirm">&times;</span>
    <h3>Confirmation de votre commande</h3>
    <p id="confirmText"></p>
  </div>
</div>

<script>
  /* URL de votre Web¬†App Apps¬†Script √† remplacer par la v√¥tre */
  const scriptURL = 'https://script.google.com/macros/s/AKfycby47wFzKyuN5N_82DGX5uCds4VK8zgTdAWF2B9-sNMLGD8K8VTGcNcnT8dW7_48azeg/exec';

  // Param√®tres de la grille
  const rows    = 17;
  const cols    = 19;
  const removed = [321, 322, 323];

  // Variables DOM
  const reserveBtn    = document.getElementById('reserve-button');
  const modal         = document.getElementById('duckModal');
  const closeModalBtn = document.getElementById('closeModal');
  const duckGrid      = document.getElementById('duckGrid');
  const selectedSpan  = document.getElementById('selectedNumbers');
  const totalSpan     = document.getElementById('totalCost');
  const finaliserBtn  = document.getElementById('finaliser');

  const confirmModal  = document.getElementById('confirmModal');
  const closeConfirm  = document.getElementById('closeConfirm');
  const confirmText   = document.getElementById('confirmText');

  // Tableaux pour les statuts
  const reservedNumbers = [];
  let selected = [];

  // Charger les statuts depuis Google¬†Sheets via Apps¬†Script
  async function chargerStatuts() {
    reservedNumbers.length = 0;
    try {
      const response = await fetch(scriptURL);
      const rowsData = await response.json();
      rowsData.forEach(row => {
        // Si la colonne 'Statut' n'est pas 'disponible', on ajoute le num√©ro
        if (row.Statut && row.Statut.toLowerCase() !== 'disponible') {
          reservedNumbers.push(parseInt(row.Numero, 10));
        }
      });
    } catch (err) {
      console.error('Erreur de chargement des statuts :', err);
    }
  }

  // Ouvrir la modale principale
  reserveBtn.addEventListener('click', async function(e) {
    e.preventDefault();
    modal.style.display = 'block';
    // Charger les statuts puis g√©n√©rer la grille
    if (!duckGrid.dataset.generated) {
      await chargerStatuts();
      generateGrid();
      duckGrid.dataset.generated = 'true';
    }
  });

  // Fermer la modale principale
  closeModalBtn.addEventListener('click', function() { modal.style.display = 'none'; });
  window.addEventListener('click', function(e) {
    if (e.target === modal) modal.style.display = 'none';
    if (e.target === confirmModal) confirmModal.style.display = 'none';
  });

  // G√©n√©ration de la grille des canards
  function generateGrid() {
    const gridWidth  = duckGrid.offsetWidth;
    const gridHeight = gridWidth * (rows / cols);
    duckGrid.style.height = gridHeight + 'px';
    for (let i = 1; i <= rows * cols; i++) {
      if (removed.includes(i)) continue;
      const div = document.createElement('div');
      div.classList.add('duck');
      const row = Math.floor((i - 1) / cols);
      const col = (i - 1) % cols;
      const wPercent = 100 / cols;
      const hPercent = 100 / rows;
      div.style.width  = wPercent + '%';
      div.style.height = hPercent + '%';
      div.style.left   = (col * wPercent) + '%';
      div.style.top    = (row * hPercent) + '%';

      if (reservedNumbers.includes(i)) {
        div.classList.add('reserved');
      } else {
        div.addEventListener('click', function() {
          toggleSelection(i, div);
        });
      }
      duckGrid.appendChild(div);
    }
  }

  // S√©lection/d√©s√©lection d'un canard
  function toggleSelection(num, el) {
    const idx = selected.indexOf(num);
    if (idx > -1) {
      selected.splice(idx, 1);
      el.classList.remove('selected');
    } else {
      selected.push(num);
      el.classList.add('selected');
    }
    updateSummary();
  }

  function updateSummary() {
    if (selected.length === 0) {
      selectedSpan.textContent = 'aucun';
    } else {
      selectedSpan.textContent = selected.slice().sort((a,b) => a-b).join(', ');
    }
    totalSpan.textContent = (selected.length * 2) + '¬†‚Ç¨';
  }

  // Cliquer sur "Finaliser ma commande" : envoi au back‚Äëend et confirmation
  finaliserBtn.addEventListener('click', async function() {
    if (selected.length === 0) {
      alert("Vous n'avez s√©lectionn√© aucun canard.");
      return;
    }
    const emailField = document.getElementById('email');
    const email = emailField.value.trim();
    if (email === "") {
      alert("Veuillez saisir votre adresse e‚Äëmail.");
      emailField.focus();
      return;
    }
    const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
    const notifyNextYear  = document.getElementById('notifyNextYear').checked;
    const sendPaymentInfo = document.getElementById('sendPaymentInfo').checked;

    // Envoi au back‚Äëend Apps¬†Script
    const dataToSend = {
      numeros: selected,
      nom: '', // ajoutez un champ pour le nom si souhait√©
      email: email,
      moyenPaiement: paymentMethod,
      notifyNextYear: notifyNextYear,
      sendPaymentInfo: sendPaymentInfo
    };

    try {
      const response = await fetch(scriptURL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dataToSend)
      });
      const result = await response.json();
      console.log('Retour Apps¬†Script :', result);

      // Recharger les statuts pour mettre √† jour les canards r√©serv√©s
      await chargerStatuts();
      // Fermer la modale principale
      modal.style.display = 'none';
      // Pr√©parer et afficher la confirmation
      showConfirmation(paymentMethod, email, notifyNextYear, sendPaymentInfo);

    } catch (err) {
      alert("Une erreur est survenue lors de l'enregistrement de votre commande.");
      console.error(err);
    }
  });

  function showConfirmation(paymentMethod, email, notifyNextYear, sendPaymentInfo) {
    let message  = "Vous avez r√©serv√© les canards : " + selected.slice().sort((a,b)=>a-b).join(', ');
    message     += "<br>Total : " + (selected.length * 2) + "‚ÄØ‚Ç¨";
    message     += "<br>M√©thode de paiement : " + (paymentMethod === "virement" ? "Par virement" : "En esp√®ces le jour de l'√©v√®nement");
    if (paymentMethod === "virement") {
      message += "<br><br><strong>Veuillez effectuer votre virement √† :</strong><br>";
      message += "IBAN¬†: BE00¬†0000¬†0000¬†0000<br>BIC¬†: ABCDBEBE<br>Communication¬†: Course des canards + votre nom";
    }
    message += "<br><br>Un e‚Äëmail de confirmation sera envoy√© √† : " + email;
    if (notifyNextYear) {
      message += "<br>‚Ä¢ Vous recevrez une invitation pour la prochaine √©dition.";
    }
    if (sendPaymentInfo) {
      message += "<br>‚Ä¢ Les informations de paiement vous seront renvoy√©es par e‚Äëmail.";
    }
    confirmText.innerHTML = message;
    confirmModal.style.display = 'block';
    // r√©initialiser la s√©lection pour la prochaine fois
    selected = [];
  }

  // Fermer la modale de confirmation
  document.getElementById('closeConfirm').addEventListener('click', function() {
    confirmModal.style.display = 'none';
  });
</script>

</body>
</html>
