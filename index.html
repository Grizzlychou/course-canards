<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Course des Canards</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
  /* …styles identiques à ceux précédemment fournis… */
</style>
</head>
<body>

<!-- Contenu de votre page (header, hero, info, etc.) -->
<!-- … -->

<!-- Modale principale (sélection + formulaire) -->
<div id="duckModal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <h3>Choisissez vos canards (2 € chacun)</h3>
    <div class="duck-grid" id="duckGrid">
      <img src="img/320-canards-jaunes.png" alt="320 canards">
    </div>
    <div id="selection">
      Canards sélectionnés : <span id="selectedNumbers">aucun</span><br>
      Total : <span id="totalCost">0 €</span>
    </div>
    <!-- Formulaire de paiement -->
    <div id="paiement">
      <!-- …radios, email, cases à cocher… -->
    </div>
    <button id="finaliser" style="margin-top:15px;padding:10px 20px;font-size:1.2em;">Finaliser ma commande</button>
  </div>
</div>

<!-- Modale de confirmation -->
<div id="confirmModal">
  <div class="content">
    <span class="close" id="closeConfirm">&times;</span>
    <h3>Confirmation de votre commande</h3>
    <p id="confirmText"></p>
  </div>
</div>

<script>
  /* URL de votre Web App Apps Script à remplacer par la vôtre */
  const scriptURL = 'https://script.google.com/macros/s/AKfycby47wFzKyuN5N_82DGX5uCds4VK8zgTdAWF2B9-sNMLGD8K8VTGcNcnT8dW7_48azeg/exec';

  // Paramètres de la grille
  const rows    = 17;
  const cols    = 19;
  const removed = [321, 322, 323];

  // Variables DOM
  const reserveBtn    = document.getElementById('reserve-button');
  const modal         = document.getElementById('duckModal');
  const closeModalBtn = document.getElementById('closeModal');
  const duckGrid      = document.getElementById('duckGrid');
  const selectedSpan  = document.getElementById('selectedNumbers');
  const totalSpan     = document.getElementById('totalCost');
  const finaliserBtn  = document.getElementById('finaliser');

  const confirmModal  = document.getElementById('confirmModal');
  const closeConfirm  = document.getElementById('closeConfirm');
  const confirmText   = document.getElementById('confirmText');

  // Tableaux pour les statuts
  const reservedNumbers = [];
  let selected = [];

  // Charger les statuts depuis Google Sheets via Apps Script
  async function chargerStatuts() {
    reservedNumbers.length = 0;
    try {
      const response = await fetch(scriptURL);
      const rowsData = await response.json();
      rowsData.forEach(row => {
        // Si la colonne 'Statut' n'est pas 'disponible', on ajoute le numéro
        if (row.Statut && row.Statut.toLowerCase() !== 'disponible') {
          reservedNumbers.push(parseInt(row.Numero, 10));
        }
      });
    } catch (err) {
      console.error('Erreur de chargement des statuts :', err);
    }
  }

  // Ouvrir la modale principale
  reserveBtn.addEventListener('click', async function(e) {
    e.preventDefault();
    modal.style.display = 'block';
    // Charger les statuts puis générer la grille
    if (!duckGrid.dataset.generated) {
      await chargerStatuts();
      generateGrid();
      duckGrid.dataset.generated = 'true';
    }
  });

  // Fermer la modale principale
  closeModalBtn.addEventListener('click', function() { modal.style.display = 'none'; });
  window.addEventListener('click', function(e) {
    if (e.target === modal) modal.style.display = 'none';
    if (e.target === confirmModal) confirmModal.style.display = 'none';
  });

  // Génération de la grille des canards
  function generateGrid() {
    const gridWidth  = duckGrid.offsetWidth;
    const gridHeight = gridWidth * (rows / cols);
    duckGrid.style.height = gridHeight + 'px';
    for (let i = 1; i <= rows * cols; i++) {
      if (removed.includes(i)) continue;
      const div = document.createElement('div');
      div.classList.add('duck');
      const row = Math.floor((i - 1) / cols);
      const col = (i - 1) % cols;
      const wPercent = 100 / cols;
      const hPercent = 100 / rows;
      div.style.width  = wPercent + '%';
      div.style.height = hPercent + '%';
      div.style.left   = (col * wPercent) + '%';
      div.style.top    = (row * hPercent) + '%';

      if (reservedNumbers.includes(i)) {
        div.classList.add('reserved');
      } else {
        div.addEventListener('click', function() {
          toggleSelection(i, div);
        });
      }
      duckGrid.appendChild(div);
    }
  }

  // Sélection/désélection d'un canard
  function toggleSelection(num, el) {
    const idx = selected.indexOf(num);
    if (idx > -1) {
      selected.splice(idx, 1);
      el.classList.remove('selected');
    } else {
      selected.push(num);
      el.classList.add('selected');
    }
    updateSummary();
  }

  function updateSummary() {
    if (selected.length === 0) {
      selectedSpan.textContent = 'aucun';
    } else {
      selectedSpan.textContent = selected.slice().sort((a,b) => a-b).join(', ');
    }
    totalSpan.textContent = (selected.length * 2) + ' €';
  }

  // Cliquer sur "Finaliser ma commande" : envoi au back‑end et confirmation
  finaliserBtn.addEventListener('click', async function() {
    if (selected.length === 0) {
      alert("Vous n'avez sélectionné aucun canard.");
      return;
    }
    const emailField = document.getElementById('email');
    const email = emailField.value.trim();
    if (email === "") {
      alert("Veuillez saisir votre adresse e‑mail.");
      emailField.focus();
      return;
    }
    const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
    const notifyNextYear  = document.getElementById('notifyNextYear').checked;
    const sendPaymentInfo = document.getElementById('sendPaymentInfo').checked;

    // Envoi au back‑end Apps Script
    const dataToSend = {
      numeros: selected,
      nom: '', // ajoutez un champ pour le nom si souhaité
      email: email,
      moyenPaiement: paymentMethod,
      notifyNextYear: notifyNextYear,
      sendPaymentInfo: sendPaymentInfo
    };

    try {
      const response = await fetch(scriptURL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dataToSend)
      });
      const result = await response.json();
      console.log('Retour Apps Script :', result);

      // Recharger les statuts pour mettre à jour les canards réservés
      await chargerStatuts();
      // Fermer la modale principale
      modal.style.display = 'none';
      // Préparer et afficher la confirmation
      showConfirmation(paymentMethod, email, notifyNextYear, sendPaymentInfo);

    } catch (err) {
      alert("Une erreur est survenue lors de l'enregistrement de votre commande.");
      console.error(err);
    }
  });

  function showConfirmation(paymentMethod, email, notifyNextYear, sendPaymentInfo) {
    let message  = "Vous avez réservé les canards : " + selected.slice().sort((a,b)=>a-b).join(', ');
    message     += "<br>Total : " + (selected.length * 2) + " €";
    message     += "<br>Méthode de paiement : " + (paymentMethod === "virement" ? "Par virement" : "En espèces le jour de l'évènement");
    if (paymentMethod === "virement") {
      message += "<br><br><strong>Veuillez effectuer votre virement à :</strong><br>";
      message += "IBAN : BE00 0000 0000 0000<br>BIC : ABCDBEBE<br>Communication : Course des canards + votre nom";
    }
    message += "<br><br>Un e‑mail de confirmation sera envoyé à : " + email;
    if (notifyNextYear) {
      message += "<br>• Vous recevrez une invitation pour la prochaine édition.";
    }
    if (sendPaymentInfo) {
      message += "<br>• Les informations de paiement vous seront renvoyées par e‑mail.";
    }
    confirmText.innerHTML = message;
    confirmModal.style.display = 'block';
    // réinitialiser la sélection pour la prochaine fois
    selected = [];
  }

  // Fermer la modale de confirmation
  document.getElementById('closeConfirm').addEventListener('click', function() {
    confirmModal.style.display = 'none';
  });
</script>

</body>
</html>
